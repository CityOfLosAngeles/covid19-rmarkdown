---
font: Lato
fontsize: 10pt
geometry: left=1in,right=1in,top=0.35in,bottom=0.6in
header-includes: \input{preamble.tex}
output:
  html_document: default
  pdf_document: default
sansfont: Lato
urlcolor: null
params:
  county: "Los Angeles"
  start_date: "2021-01-01"
---

\raggedright


```{r rmarkdown-setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(dev = "cairo_pdf")
options(knitr.kable.NA = "")
options(kableExtra.latex.load_packages = FALSE)
# Knit RMarkdown
library(knitr)
# Tables
library(kableExtra)
# Data Cleaning pipeline
library(tidyverse)
library(dplyr)
library(scales) # formatting numbers
library(arrow) # read parquets
library(zoo) # moving averages
library(reshape2)
# Plotting
library(ggplot2)
library(ggthemes)
library(plotly) #interactive charts
library(htmltools) #for ggplotly to work with loop
```


```{r import-data}
COUNTY_DEMOGRAPHICS_URL = "https://data.chhs.ca.gov/dataset/e283ee5a-cf18-4f20-a92c-ee94a2866ccd/resource/71729331-2f09-4ea4-a52f-a2661972e146/download/covid19vaccinesbycountybydemographic.csv"
ca_vaccinations<-read.csv(COUNTY_DEMOGRAPHICS_URL)


#ca_hospitalizations<-read.csv("https://raw.githubusercontent.com/CityOfLosAngeles/covid19-indicators/master/data/ca-hospital-and-surge-capacity.csv")

# Call parameters from our utils file
source("../notebooks/r_utils.R")
YESTERDAY_DATE <-YESTERDAY_DATE
TWO_WEEKS_AGO <- TWO_WEEKS_AGO
```


```{r chart-functions, echo=FALSE, out.width=c("50%", "50%")}
# chart_types = c("Age Group", "Race/Ethnicity", "VEM Quartile")
plot_charts <- function(df, county, chart_type){
  title <- df[1, "demographic_category"]

  chart_html <- plotVaxHTML(df, chart_title=title)
  
  return(chart_html)
  
}


plot_charts2 <- function(df, county, chart_type){
  subset_df <- wrangle_data(df, county) %>%
    subset(demographic_category==chart_type)
  
  chart_html <- plotVaxHTML(subset_df, chart_title="") %>%
    ggplotly(tooltip = c("date", "pct"))
  
  return(chart_html)
  
}

```





```{r make-charts, echo = FALSE, results = 'asis', fig.width = 20, fig.height = 100}
wrangle_data <-function(df, county){
  source("../notebooks/r_utils.R")
  vax_df <- prep_vaccinations(df, county)
  
  source("../notebooks/r_chart_utils.R")
  subset_df <- vax_df %>% 
    reshape2::melt(id.vars = c("county", "date",
                               "demographic_category", "demographic_value"), 
                   measure.vars = c("pct_partial_vax", "pct_fully_vax"),
                   value.name="pct")

  return(vax_df)
}


grab_vax_pct <- function(df, demog_value, var){
  subset_df <- df %>% 
    subset(demographic_value==demog_value & variable==var) 

    pct<-round(subset_df$pct*100, 1)
    return(pct)
}

format_table <- function(df, county, chart_type){
  source("../notebooks/r_utils.R")

  table <- prep_vaccinations(df, county) %>% 
    subset(date==TWO_WEEKS_AGO & demographic_category==chart_type) %>%
    select(c("demographic_value", "pct_partial_vax", "pct_fully_vax")) %>%
    mutate(
      pct_partial_vax = round(pct_partial_vax * 100, 1),
      pct_fully_vax = round(pct_fully_vax * 100, 1)
    ) 
  
  
  summary_table <- kable(table, 
                         col.names = c(
                           "Category", "% Partial Vax", "% Full Vax"),
                         align = c("l", "c", "c") ) %>%
    kable_paper(full_width = F) %>%
    column_spec(1, width="6cm") %>%
    column_spec(2, width="3cm") %>%
    column_spec(3, width="3cm") %>%
    kable_styling(fixed_thead = T, position="left") %>%
    row_spec(0, bold = T)

  return(summary_table)
}


# Programmatically write captions
# https://urban-institute.medium.com/using-r-markdown-to-track-and-publish-state-data-d1291bfa1ec0
write_caption <- function(df, county, chart_type){
  subset_df <- wrangle_data(df, county) %>% subset(date==TWO_WEEKS_AGO)
  
  race_sentence <- str_glue("The white-Black gap in for full vaccinations is {white-black}%.",
                            white = grab_vax_pct(subset_df, "White", "pct_fully_vax"),
                            black = grab_vax_pct(subset_df, "Black or African American", "pct_fully_vax")
                            )
  
  age_sentence <- str_glue("For the highest risk age group (65+ yrs), ", 
                           "{100-y65}% are **not** yet fully vaccinated.",
                           y65 = grab_vax_pct(subset_df, "65+", "pct_fully_vax")
                           )
  
  vem_sentence <- str_glue("The gap between highest Vaccine Equity Metric (VEM) quartile ",
                           "and the lowest VEM quartile is {vem4 - vem1}%.",
                           vem4 = grab_vax_pct(subset_df, "4", "pct_fully_vax"),
                           vem1 = grab_vax_pct(subset_df, "1", "pct_fully_vax")
                          )
  
  if (chart_type=="Race/Ethnicity") {
    return(race_sentence[1])
  }
  if (chart_type=="Age Group") {
    return(age_sentence[1])
  }
  if (chart_type=="VEM Quartile") {
    return(vem_sentence[1])
  }
}


plot_county_chart <- function(df, county) {
  county_df <- wrangle_data(df, county)

  chart<-plot_charts(county_df, county, "Race/Ethnicity")
  #table<-format_table(county_df, county, "Race/Ethnicity")
  #caption<-write_caption(county_df, county, "Race/Ethnicity")
  print(chart)
}

county_list = c("Los Angeles")
for (c in county_list) {
  plot_county_chart(ca_vaccinations, c)
}
```




```{r loop-charts, echo = FALSE, results = 'asis', fig.width = 20, fig.height = 100}
county_list = c("Los Angeles")

# Loop makes ggplotly disappear as output
# https://github.com/ropensci/plotly/issues/570
plotlist = list()
for (c in county_list) {
    race_chart <- plot_charts(ca_vaccinations, c, "Race/Ethnicity") 
    age_chart <- plot_charts(ca_vaccinations, c, "Age Group") 
    vem_chart <- plot_charts(ca_vaccinations, c, "VEM Quartile") 
    
    # Options for side-by-side
    #https://stackoverflow.com/questions/1249548/side-by-side-plots-with-ggplot2
    #Cleanest ex: https://github.com/ropensci/plotly/issues/570
    #If we use subplot, then chart can only have 1 title
    # Each subplot must use annotation to get its own title
    #https://stackoverflow.com/questions/45200544/title-of-subplots-in-plotly
    chart <- subplot(race_chart, age_chart, vem_chart, 
                     nrows=3) %>% 
      layout(title = paste(c, "County: Proportion Fully Vaccinated by Subgroups"))
   
    plotlist[[c]] = ggplotly(chart) 
    
}
htmltools::tagList(setNames(plotlist, NULL))
```


```{r , echo = FALSE}
#As of `r YESTERDAY_DATE`, there have been `r comma(subset_df$cases)` cumulative cases and `r #comma(subset_df$deaths)` cumulative deaths in `r params$county` County.
#https://stackoverflow.com/questions/38733403/edit-labels-in-tooltip-for-plotly-maps-using-ggplot2-in-r
```
